<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Service ROLEX</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Flex&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Roboto Flex', sans-serif;
        background: #d9cfc1;
        margin: 0;
        padding: 0;
        color: #422c17;
    }
    header {
        background: #422c17;
        color: #d9cfc1;
        padding: 40px;
        text-align: center;
        font-size: 2.5em;
        font-family: 'Roboto Flex', sans-serif;
        box-shadow: 0 4px 8px rgba(66,44,23,0.6);
    }
    .app {
        padding: 16px;
        max-width: 100%;
        margin: 0 auto;
        min-height: calc(100vh - 160px);
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .search-box input {
        width: 80%;
        padding: 30px;
        font-size: 1.5em;
        border-radius: 10px;
        border: 1px solid #422c17;
        display: block;
        margin: 0 auto;
    }
    .autocomplete {
        width: 85%;
        background: #fff;
        border-radius: 8px;
        font-size:1.5em;
        font-weight: bold;
        overflow: hidden;
        display: block;
        margin: 0 auto;
    }
    .autocomplete div {
        padding: 10px;
        cursor: pointer;
    }
    .autocomplete div:hover {
        background: #d9cfc1;
    }
    .sticky-info {
        position: sticky;
        width: 80%;
        top: 0;
        background: #6c4521;
        color: #d9cfc1;
        padding: 40px;
        margin-bottom: 5px;
        border-radius: 8px;
        z-index: 10;
        font-size: 2.2em;
        text-align: center;
        display: block;
        margin: 0 auto;
    }
    .menu {
        margin-bottom: 12px;
        border-radius: 8px;
        background: #efe8de;
        overflow: hidden;
    }
    .menu h3 {
        padding: 30px;
        cursor: pointer;
        background: #422c17;
        color: #d9cfc1;
        font-size: 2em;
        display: block;
        margin: 0 auto;
    }
    .menu-content {
        display: none;
        padding: 12px;
        flex: 1;
        font-size: 1.5em;
    }
    .menu-content.active {
        display: block;
    }
    .option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 0;
        font-size: 1.1em;
        border-bottom: 1px solid rgba(66,44,23,0.2);
    }
    .option label {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .option:last-child {
        border-bottom: none;
    }

    input[type="checkbox"] {
        transform: scale(1.8);
        cursor: pointer;
    }
    .not-available {
        font-style: italic;
        opacity: 0.6;
    }
    .total-bar {
        position: sticky;
        bottom: 0;
        background: #422c17;
        color: #d9cfc1;
        padding: 40px;
        font-size: 2.5em;
        text-align: right;
        margin-top: auto;
    }
</style>
</head>
<body>
<header>Service ROLEX</header>
<div class="app">
    <div class="search-box">
        <input type="number" id="search" placeholder="Inserisci referenza">
        <div id="autocomplete" class="autocomplete"></div>
    </div>

    <div id="info" class="sticky-info" style="display:none;"></div>

    <div id="menus" style="display:none;">
        <div class="menu">
            <h3 data-menu="partial">Lavorazione parziale</h3>
            <div id="menu-partial" class="menu-content"></div>
        </div>
        <div class="menu">
            <h3 data-menu="full">Servizio completo</h3>
            <div id="menu-full" class="menu-content"></div>
        </div>
    </div>
</div>

<div class="total-bar">
    Totale: € <span id="total">0</span>
</div>
<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTmaIek0wktWXRzvoehX4yTgXSmmbysPx1i6t1S8ZxH7eY7T5uzZhggVKfEQ7YbP4UhuYMNE-GTDHbD/pub?gid=0&single=true&output=csv";

let data = [];
let selectedRow = null;
let total = 0;

let selections = {
    partial: new Set(),
    full: new Set()
};

fetch(csvUrl)
    .then(r => r.text())
    .then(t => {
        const rows = t.split("\n").map(r => r.split(","));
        const headers = rows.shift();
        data = rows.map(r => Object.fromEntries(headers.map((h,i)=>[h.trim(), r[i]?.trim()])));
    });

const searchInput = document.getElementById("search");
const autocomplete = document.getElementById("autocomplete");

searchInput.setAttribute("inputmode", "numeric");

searchInput.addEventListener("input", () => {
    const val = searchInput.value.toLowerCase();
    autocomplete.innerHTML = "";
    if (!val) return;
    data.filter(r => r["Referenza"]?.toLowerCase().includes(val))
        .slice(0,6)
        .forEach(r => {
            const d = document.createElement("div");
            d.textContent = r["Referenza"];
            d.onclick = () => selectReference(r);
            autocomplete.appendChild(d);
        });
});

function selectReference(row){
    selectedRow = row;
    searchInput.value = row["Referenza"];
    autocomplete.innerHTML = "";
    document.getElementById("info").style.display = "block";
    document.getElementById("info").textContent = `Modello: ${row["Modello"]} — Calibro: ${row["Calibro"]}`;
    document.getElementById("menus").style.display = "block";
    // Clear menus completely before rebuilding
    document.getElementById("menu-partial").innerHTML = "";
    document.getElementById("menu-full").innerHTML = "";
    // Collapse both menus to initial state
    document.querySelectorAll(".menu-content").forEach(m => m.classList.remove("active"));
    // Reset selections and total when a new reference is selected
    total = 0;
    selections.partial = new Set();
    selections.full = new Set();
    buildMenus();
    updateTotal();
}

function buildMenus(){
    const full = document.getElementById("menu-full");
    const partial = document.getElementById("menu-partial");
    full.innerHTML = "";
    partial.innerHTML = "";

    // Get headers order to identify column H and beyond
    const keys = Object.keys(selectedRow);
    const indexH = 6; // zero-based index for column H

    // Partial section keys: "Solo cambio vetro" and "Solo lucidatura"
    const partialKeys = ["Solo cambio vetro", "Solo lucidatura"];
    let partialAvailableCount = 0;

    // Build partial menu first with only specified keys
    partialKeys.forEach(key => {
        if (!(key in selectedRow)) return;
        const priceStr = selectedRow[key];
        const price = parseFloat(priceStr);
        if (isNaN(price) || price === 0){
            return;
        }
        partialAvailableCount++;

        const opt = document.createElement("div");
        opt.className = "option";
        opt.innerHTML = `<label><input type="checkbox" data-price="${price}" data-section="partial" data-key="${key}"> ${key}</label><span>€ ${price}</span>`;

        const checkbox = opt.querySelector("input");
        checkbox.checked = selections.partial.has(key);
        checkbox.addEventListener("change", e => {
            if(e.target.checked){
                selections.partial.add(key);
            } else {
                selections.partial.delete(key);
            }
            recalcTotal();
        });

        partial.appendChild(opt);
    });
    if (partialAvailableCount === 0){
        const div = document.createElement("div");
        div.className = "option not-available";
        div.textContent = "Non disponibile";
        partial.appendChild(div);
    }

    let fullAvailableCount = 0;
    // Build full menu with all keys from column H onward
    keys.forEach((key, idx) => {
        if (["Referenza","Modello","Calibro"].includes(key)) return;
        if (partialKeys.includes(key)) return;
        if (idx < indexH) return;

        if (!(key in selectedRow)) return;
        const priceStr = selectedRow[key];
        if (!priceStr || priceStr.trim() === "") return; // skip empty fields
        const price = parseFloat(priceStr);
        const isBracelet = key.includes("Bracciale");
        const isVetro = key.includes("Vetro");

        if ((!price || price === 0) && isBracelet){
            const div = document.createElement("div");
            div.className = "option not-available";
            div.textContent = `${key}: non disponibile`;
            full.appendChild(div);
            return;
        }

        if ((!price || price === 0) && isVetro){
            const div = document.createElement("div");
            div.className = "option not-available";
            div.textContent = `${key} omaggio`;
            full.appendChild(div);
            return;
        }

        if (!price || price === 0) return; // skip zero or missing price if not bracelet

        fullAvailableCount++;
        const opt = document.createElement("div");
        opt.className = "option";
        opt.innerHTML = `<label><input type="checkbox" data-price="${price}" data-section="full" data-key="${key}"> ${key}</label><span>€ ${price}</span>`;

        const checkbox = opt.querySelector("input");
        checkbox.checked = selections.full.has(key);
        checkbox.addEventListener("change", e => {
            if(e.target.checked){
                selections.full.add(key);
            } else {
                selections.full.delete(key);
            }
            recalcTotal();
        });

        full.appendChild(opt);
    });
    
    if (fullAvailableCount === 0){
        const div = document.createElement("div");
        div.className = "option not-available";
        div.textContent = "L'orologio necessita di un preventivo dettagliato";
        full.appendChild(div);
    }
}

function recalcTotal(){
    let sum = 0;
    for(const key of selections.partial){
        const price = parseFloat(selectedRow[key]);
        if(!isNaN(price)) sum += price;
    } 
    for(const key of selections.full){
        const price = parseFloat(selectedRow[key]);
        if(!isNaN(price)) sum += price;
    }
    total = sum;
    updateTotal();
}

function updateTotal(){
    document.getElementById("total").textContent = total.toFixed(0);
}

document.querySelectorAll(".menu h3").forEach(h => {
    h.addEventListener("click", () => {
        document.querySelectorAll(".menu-content").forEach(m => m.classList.remove("active"));
        document.getElementById("menu-" + h.dataset.menu).classList.add("active");
        // Do not reset total on menu switch
    });
});
</script>
</body>
</html>
